plugins {
  id 'jacoco'
  id 'java-library'
  id 'com.diffplug.spotless' version '6.13.0'  // https://github.com/diffplug/spotless/issues/1337
  id 'com.github.ben-manes.versions' version '0.51.0'
  id 'com.github.johnrengelman.shadow' version '8.1.1'
  id 'ru.vyarus.quality' version '4.9.0'
}

group = 'com.github.tueda'
archivesBaseName = 'donuts-python'

sourceCompatibility = '1.8'
targetCompatibility = '1.8'

def versions = [
  checkstyle: '10.13.0',
  junit: '5.10.2',
  lombok: '1.18.30',
  pmd: '6.55.0',
  spotbugs: '4.8.3',
  truth: '1.4.0',
]

repositories {
  mavenCentral()
}

dependencies {
  implementation project(':donuts-java')
  compileOnly "org.projectlombok:lombok:${versions.lombok}"
  annotationProcessor "org.projectlombok:lombok:${versions.lombok}"
  testImplementation "com.google.truth:truth:${versions.truth}"
  testImplementation "org.junit.jupiter:junit-jupiter-api:${versions.junit}"
  testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:${versions.junit}"
  // for dependencyUpdates
  testRuntimeOnly "net.sourceforge.pmd:pmd:${versions.pmd}"
}

test {
  useJUnitPlatform()
  testLogging {
    events 'failed'
    exceptionFormat 'full'
  }
}

spotless {
  java {
    googleJavaFormat('1.7')
  }
  groovyGradle {
    greclipse().configFile('config/greclipse.properties')
  }
}

configurations {
  checkstyleConfig
}

dependencies {
  checkstyleConfig("com.puppycrawl.tools:checkstyle:${versions.checkstyle}") {
    transitive = false
  }
}

quality {
  checkstyleVersion = versions.checkstyle
  pmdVersion = versions.pmd
  spotbugsVersion = versions.spotbugs

  spotbugsEffort = 'max'
  spotbugsLevel = 'low'
}

afterEvaluate {
  checkstyle {
    config = resources.text.fromArchiveEntry(configurations.checkstyleConfig, 'google_checks.xml')
  }
  pmd {
    incrementalAnalysis = true
    ruleSetFiles = files('config/pmd.xml')
  }
}

shadowJar {
  minimize()
}
